<style>
.card-text {
  display: -webkit-box;
  -webkit-line-clamp: 3;
  -webkit-box-orient: vertical;
  overflow: hidden;
  text-overflow: ellipsis;
  transition: all 0.3s;
}

.card-text.expanded {
  -webkit-line-clamp: unset;
  overflow: visible;
}

.card {
  height: 100%;
  display: flex;
  flex-direction: column;
}

.card-body {
  display: flex;
  flex-direction: column;
}

.card-actions {
  margin-top: auto;
  flex-wrap: wrap;
}
</style>

<div class="container">
  <br>
  <h1 class="text-center mb-4">Browse All Resources</h1>

  <!-- Search Bar -->
  <div class="row">
    <div class="col-12">
      <%= form_with(url: browse_resources_path, method: :get, data: { turbo: false }, class: "d-flex mt-3") do |form| %>
        <%= form.text_field :query, value: params[:query], class: "form-control me-2", placeholder: "Find resources by subject or topic" %>
        <div class="input-group-append">
          <%= form.submit "Search", class: "btn btn-outline-success" %>
        </div>
      <% end %>
    </div>
  </div>

  <br>

  <!-- Filter Dropdowns -->
  <%= form_with(url: browse_resources_path, method: :get, data: { turbo: false }, class: "d-flex justify-content-start align-items-center mb-4") do %>
    <%= hidden_field_tag :query, params[:query] %>

    <div class="me-3">
      <%= select_tag :subject, options_for_select(['Maths','Science','History','English','Economics','Geography'], params[:subject]), include_blank: 'Filter by Subject', class: 'form-select', onchange: 'this.form.submit();' %>
    </div>

    <div class="me-3">
      <%= select_tag :level, options_for_select(['GCSE','A-Level','Undergraduate','Postgraduate'], params[:level]), include_blank: 'Filter by Level', class: 'form-select', onchange: 'this.form.submit();' %>
    </div>

    <div class="me-3">
      <%= select_tag :resource_type, options_for_select(['Document','Video','Quiz','Website','TedTalk','Forum'], params[:resource_type]), include_blank: 'Filter by Type', class: 'form-select', onchange: 'this.form.submit();' %>
    </div>
  <% end %>
  

  <!-- Resource Cards -->
  <% if @resources.any? %>
    <div class="row">
      <% @resources.each do |resource| %>
        <div class="col-lg-3 col-md-4 col-sm-6 mb-4">
          <div class="card h-100">
            <div class="card-body">
              <h4 class="card-title"><%= resource.title %></h4>
              <h5 class="card-subtitle mb-2 text-body-secondary"><%= resource.subject %></h5>
              <h6 class="card-subtitle mb-2 text-body-secondary"><%= resource.grade_level %></h6>
              <h6 class="card-subtitle mb-2 text-body-secondary"><%= resource.resource_type %></h6>

              <p class="card-text" id="description-<%= resource.id %>">
                <%= resource.description %>
              </p>

              <div class="card-actions d-flex justify-content-start flex-wrap pt-2">

                <!-- 1. LINK TO RESOURCE -->
                <a href="<%= resource.upload_file_or_link %>" class="btn btn-sm btn-outline-primary me-2 mb-2" target="_blank">Link to Resource</a>

                <% if current_user && @saved_resource_ids.include?(resource.id) %>
                  <% saved_item = current_user.saved_resources.find_by(resource_id: resource.id) %>
                  <%= button_to "Unsave", saved_resource_path(saved_item), method: :delete, class: "btn btn-sm btn-secondary me-2 mb-2" %>
                <% elsif current_user %>
                  <%= button_to "Save Resource", saved_resources_path(resource_id: resource.id), method: :post, class: "btn btn-sm btn-success me-2 mb-2" %>
                <% else %>
                  <button class="btn btn-sm btn-outline-secondary me-2 mb-2" disabled>Sign In to Save</button>
                <% end %>

              <% if true || resource.description.length > 100 %>
                <button class="btn btn-sm btn-outline-secondary read-more-btn mb-2" data-target-id="description-<%= resource.id %>">
                  Read More
              </button>
              <% end %>           

              </div>
            </div>
          </div>
        </div>
      <% end %>
    </div>
  <% else %>
    <p class="text-center">No resources uploaded yet.</p>
  <% end %>

  <div class="text-center mt-4">
    <%= link_to "Upload New Resource", new_resource_path, class: "btn btn-primary" %>
  </div>
  <br>
</div>

<script>
document.addEventListener('turbo:load', function() {
  document.querySelectorAll('.read-more-btn').forEach(button => {
    button.addEventListener('click', function() {
      const targetId = this.getAttribute('data-target-id');
      const descriptionElement = document.getElementById(targetId);
      const isExpanded = descriptionElement.classList.toggle('expanded');
      this.textContent = isExpanded ? 'Read Less' : 'Read More';
    });
  });
});
</script>
